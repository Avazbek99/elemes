{% extends "base.html" %}

{% block title %}{{ t('face_logs_title') }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">{{ t('face_logs_title') }}</h1>
        <p class="text-gray-500 mt-1">{{ t('face_logs_description') }}</p>
    </div>

    {% if last_request_info %}
    <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-sm text-green-800">
        <strong>{{ t('face_logs_last_request') }}:</strong>
        {{ last_request_info.time }} — IP: {{ last_request_info.ip }}
        <span class="text-green-600 ml-2">(serverni qurilma ko‘radi, so‘rovlar kelmoqda)</span>
    </div>
    {% else %}
    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 text-sm text-amber-800">
        <strong>{{ t('face_logs_diagnostic') }}:</strong>
        {{ t('face_logs_no_request_yet') }}
        <a href="{{ url_for('face_api.ping') }}" target="_blank" class="underline ml-1">{{ t('face_logs_ping_link') }}</a>
        {{ t('face_logs_check_device') }}
    </div>
    {% endif %}

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-600">
                <thead class="bg-gray-50 text-gray-900 font-semibold border-b border-gray-100">
                    <tr>
                        <th class="px-6 py-3">ID</th>
                        <th class="px-6 py-3">{{ t('face_logs_device_employee_id') }}</th>
                        <th class="px-6 py-3">{{ t('face_logs_person') }}</th>
                        <th class="px-6 py-3">{{ t('face_logs_picture') }}</th>
                        <th class="px-6 py-3">{{ t('face_logs_event_time') }}</th>
                        <th class="px-6 py-3">{{ t('face_logs_device_ip') }}</th>
                        <th class="px-6 py-3">{{ t('face_logs_created') }}</th>
                        <th class="px-6 py-3">{{ t('face_logs_raw_button') }}</th>
                    </tr>
                </thead>
                <tbody id="face-logs-tbody" class="divide-y divide-gray-100" data-raw-label="{{ t('face_logs_raw')|e }}" data-empty-label="{{ t('face_logs_empty')|e }}" data-raw-btn="{{ t('face_logs_raw_button')|e }}">
                    {% for log in logs_list %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-3 font-mono text-xs">{{ log.id }}</td>
                        <td class="px-6 py-3">{{ log.device_employee_id or '—' }}</td>
                        <td class="px-6 py-3 font-medium text-gray-900">{{ (log.person_name or '—')|upper }}</td>
                        <td class="px-6 py-3">
                            {% if log.picture_path %}
                            <a href="{{ url_for('face_api.serve_picture', log_id=log.id) }}" target="_blank" class="inline-block">
                                <img src="{{ url_for('face_api.serve_picture', log_id=log.id) }}" alt="" class="w-12 h-12 object-cover rounded border border-gray-200" loading="lazy">
                            </a>
                            {% else %}
                            —
                            {% endif %}
                        </td>
                        <td class="px-6 py-3">{{ log.event_time.strftime('%Y-%m-%d %H:%M:%S') if log.event_time else '—' }}</td>
                        <td class="px-6 py-3">{{ log.device_ip or '—' }}</td>
                        <td class="px-6 py-3 text-gray-500">{{ log.created_at.strftime('%Y-%m-%d %H:%M') if log.created_at else '—' }}</td>
                        <td class="px-6 py-3">
                            {% if log.raw_data %}
                            <button type="button" class="raw-btn text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700" data-log-id="{{ log.id }}">{{ t('face_logs_raw_button') }}</button>
                            {% else %}
                            —
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            {{ t('face_logs_empty') }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="raw-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50" style="display: none;">
    <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
        <div class="px-6 py-4 border-b flex justify-between items-center">
            <span class="font-semibold">{{ t('face_logs_raw') }}</span>
            <button type="button" onclick="closeRawModal()" class="text-gray-500 hover:text-gray-700">×</button>
        </div>
        <pre id="raw-modal-content" class="p-6 overflow-auto text-xs font-mono text-gray-700 flex-1 whitespace-pre-wrap break-all"></pre>
    </div>
</div>

<script>
window.showRawModal = function(logId) {
    fetch('{{ url_for("face_api.log_raw", log_id=999) }}'.replace('999', logId), { credentials: 'same-origin' })
        .then(r => r.text())
        .then(text => {
            document.getElementById('raw-modal-content').textContent = text || '(bo\'sh)';
            document.getElementById('raw-modal').style.display = 'flex';
        })
        .catch(() => { document.getElementById('raw-modal-content').textContent = 'Xato'; document.getElementById('raw-modal').style.display = 'flex'; });
};
window.closeRawModal = function() {
    document.getElementById('raw-modal').style.display = 'none';
};
document.getElementById('raw-modal') && document.getElementById('raw-modal').addEventListener('click', function(e) {
    if (e.target === this) closeRawModal();
});

(function() {
    const tbody = document.getElementById('face-logs-tbody');
    if (!tbody) return;
    const logsUrl = '{{ url_for("face_api.logs") }}?limit=100';
    const rawBtnLabel = tbody.dataset.rawBtn || 'Raw';
    const pictureUrl = (id) => '{{ url_for("face_api.serve_picture", log_id=999) }}'.replace('999', id);

    function fmtDate(iso) {
        if (!iso) return '—';
        try {
            const d = new Date(iso);
            return d.toISOString().replace('T',' ').slice(0, 19);
        } catch(_) { return iso.slice(0, 19); }
    }
    function fmtShort(iso) {
        if (!iso) return '—';
        try {
            const d = new Date(iso);
            return d.toISOString().slice(0, 16).replace('T',' ');
        } catch(_) { return iso.slice(0, 16); }
    }

    function renderRow(log) {
        const devEmpId = log.device_employee_id || '—';
        const name = (log.person_name || '—').toUpperCase();
        const pic = log.picture_path ? `<a href="${pictureUrl(log.id)}" target="_blank"><img src="${pictureUrl(log.id)}" alt="" class="w-12 h-12 object-cover rounded border border-gray-200" loading="lazy"></a>` : '—';
        const evtTime = fmtDate(log.event_time);
        const devIp = log.device_ip || '—';
        const created = fmtShort(log.created_at);
        const rawBtn = (log.has_raw || log.raw_data) ? `<button type="button" class="raw-btn text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700" data-log-id="${log.id}">${rawBtnLabel}</button>` : '—';
        return `<tr class="hover:bg-gray-50 transition-colors"><td class="px-6 py-3 font-mono text-xs">${log.id}</td><td class="px-6 py-3">${devEmpId}</td><td class="px-6 py-3 font-medium text-gray-900">${name}</td><td class="px-6 py-3">${pic}</td><td class="px-6 py-3">${evtTime}</td><td class="px-6 py-3">${devIp}</td><td class="px-6 py-3 text-gray-500">${created}</td><td class="px-6 py-3">${rawBtn}</td></tr>`;
    }

    tbody.addEventListener('click', function(e) {
        const btn = e.target.closest('.raw-btn');
        if (btn && btn.dataset.logId) showRawModal(btn.dataset.logId);
    });

    function fetchLogs() {
        fetch(logsUrl, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success' && data.logs && data.logs.length >= 0) {
                    if (data.logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500">' + (tbody.dataset.emptyLabel || 'Loglar topilmadi') + '</td></tr>';
                    } else {
                        tbody.innerHTML = data.logs.map(renderRow).join('');
                    }
                }
            })
            .catch(() => {});
    }

    setInterval(fetchLogs, 5000);
    setTimeout(fetchLogs, 1000);
})();
</script>
{% endblock %}
