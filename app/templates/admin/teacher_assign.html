{% extends "base.html" %}

{% block title %}{{ t('assign_teachers_menu') }}{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet" />
<style>
    .ts-control { border-radius: 0.5rem !important; padding: 0.5rem 0.75rem !important; border: 1px solid #d1d5db !important; font-size: 0.875rem !important; box-shadow: none !important; }
    .ts-control:focus-within { border-color: var(--color-primary-500, #0ea5e9) !important; box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2) !important; }
    .ts-dropdown { border-radius: 0.75rem !important; margin-top: 4px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1) !important; border: 1px solid #f3f4f6 !important; }
    .ts-dropdown .active { background-color: #f0f9ff !important; color: #0369a1 !important; }
    .ts-dropdown .option { padding: 8px 12px !important; font-size: 0.875rem !important; }
    .ts-wrapper.teacher-select { min-width: 280px; width: 100%; }
    .ts-wrapper.teacher-select .ts-control { min-width: 280px; }
    .ts-wrapper.filter-select { min-width: 120px; }
    .assign-table tbody tr { border-bottom: 1px solid #e5e7eb; }
    .assign-table tbody tr:hover { background-color: #f0f9ff; }
    .assign-table th { border-bottom: 2px solid #d1d5db; }
    .search-input-wrap { position: relative; }
    .search-input-wrap input { padding-right: 2.25rem !important; }
    .search-clear-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; border: none; background: none; cursor: pointer; color: #9ca3af; font-size: 1.25rem; line-height: 1; border-radius: 0.25rem; }
    .search-clear-btn:hover { color: #374151; background: #f3f4f6; }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex flex-wrap justify-between items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ t('assign_teachers_menu') }}</h1>
            <p class="text-gray-500 mt-1">{{ t('assign_teachers_subtitle') }}</p>
        </div>
    </div>

    <!-- Filter form -->
    <form method="GET" action="{{ url_for('admin.teacher_assign') }}" id="assignFilterForm" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-6">
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 items-end">
            <!-- Kafedra -->
            <div class="min-w-0">
                <label class="block text-xs font-medium text-gray-500 mb-1">{{ t('department') }}</label>
                <select name="department_id" id="filter_department" class="filter-select-init w-full px-3 py-2 border border-gray-300 rounded-xl text-sm">
                    <option value="">{{ t('all') }}</option>
                    {% for d in departments %}
                    <option value="{{ d.id }}" {% if filter_department == d.id|string %}selected{% endif %}>{{ d.get_display_name(current_lang) or d.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Semestr -->
            <div class="min-w-0">
                <label class="block text-xs font-medium text-gray-500 mb-1">{{ t('semester') }}</label>
                <select name="semester" id="filter_semester" class="filter-select-init w-full px-3 py-2 border border-gray-300 rounded-xl text-sm">
                    <option value="">{{ t('all') }}</option>
                    {% for sem in semesters %}
                    <option value="{{ sem }}" {% if filter_semester == sem|string %}selected{% endif %}>{{ sem }}-{{ t('semester')|lower }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Yo'nalish -->
            <div class="min-w-0">
                <label class="block text-xs font-medium text-gray-500 mb-1">{{ t('direction') }}</label>
                <select name="direction_id" id="filter_direction" class="filter-select-init w-full px-3 py-2 border border-gray-300 rounded-xl text-sm">
                    <option value="">{{ t('all') }}</option>
                    {% for dir_id, dir_name in directions %}
                    <option value="{{ dir_id }}" {% if filter_direction == dir_id|string %}selected{% endif %}>{{ dir_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Guruh -->
            <div class="min-w-0">
                <label class="block text-xs font-medium text-gray-500 mb-1">{{ t('group') }}</label>
                <select name="group_id" id="filter_group" class="filter-select-init w-full px-3 py-2 border border-gray-300 rounded-xl text-sm">
                    <option value="">{{ t('all') }}</option>
                    {% for grp_id, grp_name in groups %}
                    <option value="{{ grp_id }}" {% if filter_group == grp_id|string %}selected{% endif %}>{{ grp_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Fan -->
            <div class="min-w-0">
                <label class="block text-xs font-medium text-gray-500 mb-1">{{ t('subject') }}</label>
                <select name="subject_id" id="filter_subject" class="filter-select-init w-full px-3 py-2 border border-gray-300 rounded-xl text-sm">
                    <option value="">{{ t('all') }}</option>
                    {% for subj_id, subj_name in subjects %}
                    <option value="{{ subj_id }}" {% if filter_subject == subj_id|string %}selected{% endif %}>{{ subj_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Dars turi -->
            <div class="min-w-0">
                <label class="block text-xs font-medium text-gray-500 mb-1">{{ t('lesson_type') }}</label>
                <select name="lesson_type" id="filter_lesson_type" class="filter-select-init w-full px-3 py-2 border border-gray-300 rounded-xl text-sm">
                    <option value="">{{ t('all') }}</option>
                    {% for lt in lesson_types_choices %}
                    <option value="{{ lt }}" {% if filter_lesson_type == lt %}selected{% endif %}>{{ lt|lesson_type_label }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Holat -->
            <div class="min-w-0">
                <label class="block text-xs font-medium text-gray-500 mb-1">{{ t('status') }}</label>
                <select name="status" id="filter_status" class="filter-select-init w-full px-3 py-2 border border-gray-300 rounded-xl text-sm">
                    <option value="">{{ t('all') }}</option>
                    <option value="assigned" {% if filter_status == 'assigned' %}selected{% endif %}>{{ t('assigned') }}</option>
                    <option value="not_assigned" {% if filter_status == 'not_assigned' %}selected{% endif %}>{{ t('not_assigned') }}</option>
                </select>
            </div>
        </div>
        <div class="flex gap-3 mt-4 items-center">
            <div class="flex-1">
                <div class="search-input-wrap">
                    <input type="text" name="q" id="searchInput" value="{{ search_q }}" placeholder="{{ t('search') }}..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <button type="button" class="search-clear-btn" title="{{ t('clear') }}">×</button>
                </div>
            </div>
            <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-xl hover:bg-primary-700 transition-colors text-sm font-medium shrink-0">{{ t('search') }}</button>
            <a href="{{ url_for('admin.teacher_assign') }}" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors text-sm font-medium shrink-0">{{ t('clear') }}</a>
        </div>
    </form>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 flex items-center justify-between">
        <span class="text-sm text-gray-600">{{ t('total_rows') }}: <strong>{{ rows|length }}</strong></span>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            {% set _filter_params = {'department_id': filter_department, 'semester': filter_semester, 'direction_id': filter_direction, 'group_id': filter_group, 'subject_id': filter_subject, 'lesson_type': filter_lesson_type, 'status': filter_status, 'q': search_q} %}
            <table class="w-full min-w-[1200px] assign-table">
                <thead class="bg-gray-50">
                    <tr class="border-b-2 border-gray-300">
                        <th class="px-4 py-3 text-left">
                            <a href="{{ url_for('admin.teacher_assign', sort='department', order='desc' if sort_by == 'department' and sort_order == 'asc' else 'asc', **_filter_params) }}"
                                class="text-xs font-semibold text-gray-600 uppercase hover:text-primary-600">
                                {{ t('department') }} {% if sort_by == 'department' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                            </a>
                        </th>
                        <th class="px-4 py-3 text-left">
                            <a href="{{ url_for('admin.teacher_assign', sort='semester', order='desc' if sort_by == 'semester' and sort_order == 'asc' else 'asc', **_filter_params) }}"
                                class="text-xs font-semibold text-gray-600 uppercase hover:text-primary-600">
                                {{ t('semester') }} {% if sort_by == 'semester' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                            </a>
                        </th>
                        <th class="px-4 py-3 text-left">
                            <a href="{{ url_for('admin.teacher_assign', sort='direction', order='desc' if sort_by == 'direction' and sort_order == 'asc' else 'asc', **_filter_params) }}"
                                class="text-xs font-semibold text-gray-600 uppercase hover:text-primary-600">
                                {{ t('direction') }} {% if sort_by == 'direction' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                            </a>
                        </th>
                        <th class="px-4 py-3 text-left">
                            <a href="{{ url_for('admin.teacher_assign', sort='group', order='desc' if sort_by == 'group' and sort_order == 'asc' else 'asc', **_filter_params) }}"
                                class="text-xs font-semibold text-gray-600 uppercase hover:text-primary-600">
                                {{ t('group') }} {% if sort_by == 'group' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                            </a>
                        </th>
                        <th class="px-4 py-3 text-left">
                            <a href="{{ url_for('admin.teacher_assign', sort='subject', order='desc' if sort_by == 'subject' and sort_order == 'asc' else 'asc', **_filter_params) }}"
                                class="text-xs font-semibold text-gray-600 uppercase hover:text-primary-600">
                                {{ t('subject') }} {% if sort_by == 'subject' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                            </a>
                        </th>
                        <th class="px-4 py-3 text-left">
                            <a href="{{ url_for('admin.teacher_assign', sort='lesson_type', order='desc' if sort_by == 'lesson_type' and sort_order == 'asc' else 'asc', **_filter_params) }}"
                                class="text-xs font-semibold text-gray-600 uppercase hover:text-primary-600">
                                {{ t('lesson_type') }} {% if sort_by == 'lesson_type' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                            </a>
                        </th>
                        <th class="px-4 py-3 text-center">
                            <a href="{{ url_for('admin.teacher_assign', sort='hours', order='desc' if sort_by == 'hours' and sort_order == 'asc' else 'asc', **_filter_params) }}"
                                class="text-xs font-semibold text-gray-600 uppercase hover:text-primary-600">
                                {{ t('hours') }} {% if sort_by == 'hours' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                            </a>
                        </th>
                        <th class="px-4 py-3 text-left">
                            <a href="{{ url_for('admin.teacher_assign', sort='teacher', order='desc' if sort_by == 'teacher' and sort_order == 'asc' else 'asc', **_filter_params) }}"
                                class="text-xs font-semibold text-gray-600 uppercase hover:text-primary-600">
                                {{ t('teacher') }} {% if sort_by == 'teacher' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                            </a>
                        </th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">{{ t('actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                    <tr class="border-b border-gray-100 hover:bg-primary-50 transition-colors {% if loop.index is even %}bg-gray-50/50{% endif %}">
                        <td class="px-4 py-3 text-sm text-gray-500">{{ row.department_name or '—' }}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ row.semester }}-{{ t('semester') | lower }}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ row.direction_name }}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 font-medium">{{ row.group_name }}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">{{ row.subject_name }}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if row.lesson_type == 'maruza' %}bg-blue-100 text-blue-800
                                {% elif row.lesson_type == 'amaliyot' %}bg-green-100 text-green-800
                                {% elif row.lesson_type == 'laboratoriya' %}bg-purple-100 text-purple-800
                                {% elif row.lesson_type == 'seminar' %}bg-orange-100 text-orange-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ row.lesson_type|capitalize }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700 text-center">{{ row.hours }}</td>
                        <td class="px-4 py-3 text-sm">
                            <form method="POST" action="{{ url_for('admin.teacher_assign_save', **_filter_params) }}" class="flex items-center gap-2" id="form-{{ loop.index }}">
                                <input type="hidden" name="subject_id" value="{{ row.subject_id }}">
                                <input type="hidden" name="group_id" value="{{ row.group_id }}">
                                <input type="hidden" name="lesson_type" value="{{ row.lesson_type }}">
                                <select name="teacher_id" id="teacher_select_{{ loop.index }}" class="teacher-select-init">
                                    <option value="">— {{ t('select_teacher') }} —</option>
                                    {% for teacher in teachers %}
                                    <option value="{{ teacher.id }}" {% if row.teacher_id == teacher.id %}selected{% endif %}>{{ teacher.full_name | upper }}</option>
                                    {% endfor %}
                                </select>
                            </form>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button type="submit" form="form-{{ loop.index }}" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 transition-colors">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {{ t('save') }}
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                            {{ t('no_results') }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('assignFilterForm');
    var filterOpts = { create: false, allowEmptyOption: true, maxOptions: 500, plugins: ['dropdown_input'] };
    
    document.querySelectorAll('.filter-select-init').forEach(function(el) {
        var ts = new TomSelect(el, filterOpts);
        ts.wrapper.classList.add('filter-select');
        ts.on('change', function() { if (form) form.submit(); });
    });
    
    var placeholder = {{ t("select_teacher") | tojson }};
    document.querySelectorAll('.teacher-select-init').forEach(function(el) {
        var ts = new TomSelect(el, {
            create: false,
            allowEmptyOption: true,
            maxOptions: 500,
            plugins: ['dropdown_input']
        });
        ts.wrapper.classList.add('teacher-select');
    });
    
    var searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.focus();
        searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
        var searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() { if (form) form.submit(); }, 500);
        });
    }
    
    document.querySelectorAll('.search-clear-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var wrap = this.closest('.search-input-wrap');
            if (wrap) {
                var inp = wrap.querySelector('input');
                if (inp) { inp.value = ''; if (form) form.submit(); }
            }
        });
    });
});
</script>
{% endblock %}
