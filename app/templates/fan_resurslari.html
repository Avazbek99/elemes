{% extends "base.html" %}

{% block title %}{{ t('subject_resources') }}{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet" />
<style>
    .ts-control { border-radius: 0.5rem !important; padding: 0.5rem 0.75rem !important; border: 1px solid #d1d5db !important; font-size: 0.875rem !important; box-shadow: none !important; }
    .ts-control:focus-within { border-color: var(--color-primary-500, #0ea5e9) !important; box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2) !important; }
    .ts-dropdown { border-radius: 0.75rem !important; margin-top: 4px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1) !important; border: 1px solid #f3f4f6 !important; }
    .ts-dropdown .active { background-color: #f0f9ff !important; color: #0369a1 !important; }
    .ts-dropdown .option { padding: 8px 12px !important; font-size: 0.875rem !important; }
    .search-input-wrap { position: relative; }
    .search-input-wrap input { padding-right: 2.25rem !important; }
    .search-clear-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; border: none; background: none; cursor: pointer; color: #9ca3af; font-size: 1.25rem; line-height: 1; border-radius: 0.25rem; }
    .search-clear-btn:hover { color: #374151; background: #f3f4f6; }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex flex-wrap justify-between items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ t('subject_resources') }}</h1>
            <p class="text-gray-500 mt-1">{{ t('subject_resources_subtitle') }}</p>
        </div>
        <div class="flex gap-2 ml-auto shrink-0">
            <a href="{{ url_for('main.fan_resurslari_export', progress=progress_filter, q=search_q, lesson_type=lesson_type_q, sort=sort_by, order=sort_order, **({'department_id': department_id} if department_id else {})) }}"
                class="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-colors flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                {{ t('export') }}
            </a>
        </div>
    </div>

    {% set _url_department = {'department_id': department_id} if department_id else {} %}
    <form method="GET" action="{{ url_for('main.fan_resurslari') }}" id="fanResurslariFilterForm" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-6 w-full max-w-full">
        <div class="grid grid-cols-1 sm:grid-cols-[minmax(0,1fr)_minmax(0,1fr)_minmax(0,1fr)_minmax(0,1fr)_auto] gap-4 items-end">
            <div class="min-w-0">
                <label class="block text-xs font-medium text-gray-500 mb-1">{{ t('departments') }}</label>
                <div class="filter-select-wrap relative">
                    <select name="department_id" id="department_filter" class="w-full px-3 py-2 pr-8 border border-gray-300 rounded-xl text-sm tom-select-init">
                        <option value="" {% if not department_id %}selected{% endif %}>{{ t('all') }}</option>
                        {% for d in departments %}
                        <option value="{{ d.id }}" {% if department_id == d.id %}selected{% endif %}>{{ d.get_display_name(current_lang) or d.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="filter-clear-btn" title="{{ t('clear') }}" aria-label="{{ t('clear') }}">×</button>
                </div>
            </div>
            <div class="min-w-0">
                <label class="block text-xs font-medium text-gray-500 mb-1">{{ t('resource') }} %</label>
                <div class="filter-select-wrap relative">
                    <select name="progress" id="progress_filter" class="w-full px-3 py-2 pr-8 border border-gray-300 rounded-xl text-sm tom-select-init">
                        <option value="" {% if not progress_filter %}selected{% endif %}>{{ t('all') }}</option>
                        <option value="0" {% if progress_filter == '0' %}selected{% endif %}>0%</option>
                        <option value="not100" {% if progress_filter == 'not100' %}selected{% endif %}>&lt; 100%</option>
                        <option value="100" {% if progress_filter == '100' %}selected{% endif %}>100%</option>
                    </select>
                    <button type="button" class="filter-clear-btn" title="{{ t('clear') }}" aria-label="{{ t('clear') }}">×</button>
                </div>
            </div>
            <div class="min-w-0">
                <label class="block text-xs font-medium text-gray-500 mb-1">{{ t('lesson_type') }}</label>
                <div class="filter-select-wrap relative">
                    <select name="lesson_type" id="lesson_type_filter" class="w-full px-3 py-2 pr-8 border border-gray-300 rounded-xl text-sm tom-select-init">
                        <option value="" {% if not lesson_type_q %}selected{% endif %}>{{ t('all') }}</option>
                        {% for lt in lesson_types_choices %}
                        <option value="{{ lt }}" {% if lesson_type_q == lt|lower %}selected{% endif %}>{{ lt|lesson_type_label }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="filter-clear-btn" title="{{ t('clear') }}" aria-label="{{ t('clear') }}">×</button>
                </div>
            </div>
            <div class="min-w-0">
                <label class="block text-xs font-medium text-gray-500 mb-1">{{ t('search') }}</label>
                <div class="search-input-wrap">
                    <input type="text" name="q" id="searchInput" value="{{ search_q }}" placeholder="{{ t('search_resources_placeholder') }}"
                        class="w-full px-4 py-2 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <button type="button" class="search-clear-btn" title="{{ t('clear') }}" aria-label="{{ t('clear') }}">×</button>
                </div>
            </div>
            <div class="flex flex-wrap gap-2 items-end min-w-0">
                <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-xl hover:bg-primary-700 transition-colors text-sm font-medium">{{ t('search') }}</button>
                <a href="{{ url_for('main.fan_resurslari') }}" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors text-sm font-medium">{{ t('clear') }}</a>
            </div>
        </div>
    </form>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden overflow-x-auto">
        <div class="p-4 border-b border-gray-100 bg-gray-50/50">
            <p class="text-sm text-gray-600">{{ t('total_rows') }}: <span class="font-bold text-gray-900">{{ rows|length }}</span></p>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full min-w-[700px] border-collapse">
                <thead>
                    <tr>
                        <th rowspan="2" class="text-center align-middle px-4 py-3 text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-300">
                            <a href="{{ url_for('main.fan_resurslari', sort='department', order=(sort_order == 'asc' and sort_by == 'department') and 'desc' or 'asc', progress=progress_filter, q=search_q, lesson_type=lesson_type_q, **_url_department) }}"
                                class="block text-gray-700 hover:text-primary-600 transition-colors whitespace-nowrap">
                                {{ t('departments') }}
                                {% if sort_by == 'department' %}<span class="ml-1">{{ sort_order == 'asc' and '↑' or '↓' }}</span>{% endif %}
                            </a>
                        </th>
                        <th rowspan="2" class="text-center align-middle px-4 py-3 text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-300">
                            <a href="{{ url_for('main.fan_resurslari', sort='teacher', order=(sort_order == 'asc' and sort_by == 'teacher') and 'desc' or 'asc', progress=progress_filter, q=search_q, lesson_type=lesson_type_q, **_url_department) }}"
                                class="block text-gray-700 hover:text-primary-600 transition-colors whitespace-nowrap">
                                {{ t('teachers') }}
                                {% if sort_by == 'teacher' %}<span class="ml-1">{{ sort_order == 'asc' and '↑' or '↓' }}</span>{% endif %}
                            </a>
                        </th>
                        <th rowspan="2" class="text-center align-middle px-4 py-3 text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-300">
                            <a href="{{ url_for('main.fan_resurslari', sort='subject', order=(sort_order == 'asc' and sort_by == 'subject') and 'desc' or 'asc', progress=progress_filter, q=search_q, lesson_type=lesson_type_q, **_url_department) }}"
                                class="block text-gray-700 hover:text-primary-600 transition-colors whitespace-nowrap">
                                {{ t('subjects') }}
                                {% if sort_by == 'subject' %}<span class="ml-1">{{ sort_order == 'asc' and '↑' or '↓' }}</span>{% endif %}
                            </a>
                        </th>
                        <th rowspan="2" class="text-center align-middle px-4 py-3 text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-300">
                            <a href="{{ url_for('main.fan_resurslari', sort='direction', order=(sort_order == 'asc' and sort_by == 'direction') and 'desc' or 'asc', progress=progress_filter, q=search_q, lesson_type=lesson_type_q, **_url_department) }}"
                                class="block text-gray-700 hover:text-primary-600 transition-colors whitespace-nowrap">
                                {{ t('directions') }}
                                {% if sort_by == 'direction' %}<span class="ml-1">{{ sort_order == 'asc' and '↑' or '↓' }}</span>{% endif %}
                            </a>
                        </th>
                        <th rowspan="2" class="text-center align-middle px-4 py-3 text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-300">
                            <a href="{{ url_for('main.fan_resurslari', sort='group', order=(sort_order == 'asc' and sort_by == 'group') and 'desc' or 'asc', progress=progress_filter, q=search_q, lesson_type=lesson_type_q, **_url_department) }}"
                                class="block text-gray-700 hover:text-primary-600 transition-colors whitespace-nowrap">
                                {{ t('groups') }}
                                {% if sort_by == 'group' %}<span class="ml-1">{{ sort_order == 'asc' and '↑' or '↓' }}</span>{% endif %}
                            </a>
                        </th>
                        <th rowspan="2" class="text-center align-middle px-4 py-3 text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-300">
                            <a href="{{ url_for('main.fan_resurslari', sort='lesson_type', order=(sort_order == 'asc' and sort_by == 'lesson_type') and 'desc' or 'asc', progress=progress_filter, q=search_q, lesson_type=lesson_type_q, **_url_department) }}"
                                class="block text-gray-700 hover:text-primary-600 transition-colors whitespace-nowrap">
                                {{ t('lesson_type') }}
                                {% if sort_by == 'lesson_type' %}<span class="ml-1">{{ sort_order == 'asc' and '↑' or '↓' }}</span>{% endif %}
                            </a>
                        </th>
                        <th colspan="3" class="text-center align-middle px-4 py-3 text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-300">
                            {{ t('curriculum_hours_unit')|capitalize }}
                        </th>
                        <th rowspan="2" class="text-center align-middle px-4 py-3 text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-300">
                            <a href="{{ url_for('main.fan_resurslari', sort='progress', order=(sort_order == 'asc' and sort_by == 'progress') and 'desc' or 'asc', progress=progress_filter, q=search_q, lesson_type=lesson_type_q, **_url_department) }}"
                                class="block text-gray-700 hover:text-primary-600 transition-colors whitespace-nowrap">
                                {{ t('resource') }}
                                {% if sort_by == 'progress' %}<span class="ml-1">{{ sort_order == 'asc' and '↑' or '↓' }}</span>{% endif %}
                            </a>
                        </th>
                    </tr>
                    <tr>
                        <th class="text-center px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-300">
                            <a href="{{ url_for('main.fan_resurslari', sort='total_hours', order=(sort_order == 'asc' and sort_by == 'total_hours') and 'desc' or 'asc', progress=progress_filter, q=search_q, lesson_type=lesson_type_q, **_url_department) }}"
                                class="block text-gray-700 hover:text-primary-600 transition-colors whitespace-nowrap">({{ t('hours_plan') }})
                                {% if sort_by == 'total_hours' %}<span class="ml-1">{{ sort_order == 'asc' and '↑' or '↓' }}</span>{% endif %}
                            </a>
                        </th>
                        <th class="text-center px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-300">
                            <a href="{{ url_for('main.fan_resurslari', sort='loaded_hours', order=(sort_order == 'asc' and sort_by == 'loaded_hours') and 'desc' or 'asc', progress=progress_filter, q=search_q, lesson_type=lesson_type_q, **_url_department) }}"
                                class="block text-gray-700 hover:text-primary-600 transition-colors whitespace-nowrap">({{ t('hours_loaded') }})
                                {% if sort_by == 'loaded_hours' %}<span class="ml-1">{{ sort_order == 'asc' and '↑' or '↓' }}</span>{% endif %}
                            </a>
                        </th>
                        <th class="text-center px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 border border-gray-300">
                            <a href="{{ url_for('main.fan_resurslari', sort='remaining_hours', order=(sort_order == 'asc' and sort_by == 'remaining_hours') and 'desc' or 'asc', progress=progress_filter, q=search_q, lesson_type=lesson_type_q, **_url_department) }}"
                                class="block text-gray-700 hover:text-primary-600 transition-colors whitespace-nowrap">({{ t('remaining_label') }})
                                {% if sort_by == 'remaining_hours' %}<span class="ml-1">{{ sort_order == 'asc' and '↑' or '↓' }}</span>{% endif %}
                            </a>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                    <tr class="border-b border-gray-200 hover:bg-primary-100 transition-colors {% if loop.index is even %}bg-gray-50/50{% endif %}">
                        <td class="px-6 py-4 text-sm text-gray-500">{{ (row.department_names or '—')|safe }}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">{{ row.teacher_name }}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">{{ row.subject_name }}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">{{ row.direction_name or '—' }}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">{{ row.group_name }}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 text-center"><span class="px-2 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700">{{ row.lesson_type|lesson_type_label }}</span></td>
                        <td class="px-6 py-4 text-sm text-gray-900 text-center">{{ row.total_hours }}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 text-center">{{ row.loaded_hours }}</td>
                        <td class="px-6 py-4 text-sm text-center {% if row.remaining_hours > 0 %}text-amber-600 font-medium{% else %}text-gray-500{% endif %}">{{ row.remaining_hours }}</td>
                        <td class="px-6 py-4 text-sm text-center"><span class="{% if row.progress_percent >= 100 %}text-green-600{% elif row.progress_percent > 0 %}text-blue-600{% else %}text-red-600{% endif %} font-bold">{{ row.progress_percent }}%</span></td>
                    </tr>
                    {% else %}
                    <tr><td colspan="10" class="px-6 py-12 text-center text-gray-500">{{ t('no_data') if t('no_data') != 'no_data' else "Ma'lumot yo'q" }}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    window.tomSelectInstances = window.tomSelectInstances || {};
    var form = document.getElementById('fanResurslariFilterForm');
    var opts = { create: false, allowEmptyOption: true, maxOptions: 500, plugins: ['dropdown_input'] };
    ['department_filter', 'progress_filter', 'lesson_type_filter'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) {
            var ts = new TomSelect(el, opts);
            window.tomSelectInstances[id] = ts;
            ts.on('change', function() { if (form) form.submit(); });
        }
    });
    var searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.focus();
        searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
        var searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() { if (form) form.submit(); }, 500);
        });
    }
    document.querySelectorAll('.search-clear-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var wrap = this.closest('.search-input-wrap');
            if (wrap) {
                var inp = wrap.querySelector('input');
                if (inp) { inp.value = ''; if (form) form.submit(); }
            }
        });
    });
});
</script>
{% endblock %}
