<!DOCTYPE html>
<html lang="{{ current_lang }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}{{ site_name_short or '' }}{% endblock %}</title>
    {% if site_logo_filename %}
    <link rel="icon" id="favicon-link" href="{{ url_for('admin.serve_site_upload', filename=site_logo_filename) }}" sizes="64x64">
    {% else %}
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    {% endif %}
    <script>
    (function(){
        var link = document.getElementById('favicon-link');
        if (!link || !link.href) return;
        var size = 64;
        var img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function(){
            try {
                var c = document.createElement('canvas');
                c.width = size;
                c.height = size;
                var ctx = c.getContext('2d');
                var w = img.width, h = img.height;
                var scale = Math.min(size/w, size/h);
                var dw = Math.round(w*scale), dh = Math.round(h*scale);
                var x = (size-dw)>>1, y = (size-dh)>>1;
                ctx.fillStyle = 'transparent';
                ctx.fillRect(0,0,size,size);
                ctx.drawImage(img, x, y, dw, dh);
                link.href = c.toDataURL('image/png');
            } catch(e) {}
        };
        img.onerror = function(){};
        img.src = link.href;
    })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc',
                            400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1',
                            800: '#075985', 900: '#0c4a6e', 950: '#082f49',
                        },
                        dark: {
                            50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1',
                            400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155',
                            800: '#1e293b', 900: '#0f172a', 950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .sidebar-link.active {
            background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
        }

        /* Sidebar nav scrollbar yashirish — scroll ishlashi saqlanadi */
        #sidebar-nav {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE, Edge */
        }
        #sidebar-nav::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        @keyframes slide-in-up {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-slide-in {
            animation: slide-in-up 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Kontent ekrandan chiqib ketmasin */
        main {
            overflow-x: hidden;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
        }
        /* Jadval konteynerlari — gorizontal scroll */
        main .overflow-x-auto {
            max-width: 100%;
        }
        main div:has(> table) {
            overflow-x: auto;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        main div:has(> table) table {
            min-width: 640px;
        }

        /* Roʻyxat (jadval) — ekran kengligiga qarab kichiklashadi */
        main table {
            font-size: clamp(0.8125rem, 1.2vw + 0.5rem, 0.875rem);
        }
        main table th,
        main table td {
            padding: clamp(0.5rem, 1.2vw, 1rem) clamp(0.75rem, 1.5vw, 1.5rem);
            font-size: inherit;
        }
        main table th {
            font-size: clamp(0.6875rem, 1vw + 0.4rem, 0.75rem);
        }

        /* Qidiruv/filtr input ichida "x" tozalash tugmasi */
        .search-input-wrap { position: relative; }
        .search-input-wrap input.pr-clear { padding-right: 2.25rem; }
        .search-clear-btn {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            color: #9ca3af;
            font-size: 1.25rem;
            line-height: 1;
            cursor: pointer;
            border-radius: 9999px;
            transition: color 0.15s, background 0.15s;
        }
        .search-clear-btn:hover { color: #374151; background: #f3f4f6; }
        .search-clear-btn.hidden { display: none !important; }

        /* Filtr select ichida "x" tozalash tugmasi */
        .filter-select-wrap { position: relative; display: flex; align-items: center; }
        .filter-select-wrap .ts-wrapper { flex: 1; min-width: 0; }
        .filter-select-wrap .ts-control { padding-right: 2rem !important; }
        .filter-select-wrap > select:first-child { flex: 1; min-width: 0; }
        .filter-clear-btn {
            position: absolute;
            right: 0.35rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1.35rem;
            height: 1.35rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            color: #9ca3af;
            font-size: 1.1rem;
            line-height: 1;
            cursor: pointer;
            border-radius: 9999px;
            transition: color 0.15s, background 0.15s;
            flex-shrink: 0;
        }
        .filter-clear-btn:hover { color: #374151; background: #f3f4f6; }
        .filter-clear-btn.hidden { display: none !important; }

        /* 1440px va kichikroq — jadval matni va padding yanada kam */
        @media (max-width: 1440px) {
            main table th,
            main table td {
                padding: 0.5rem 0.75rem;
                font-size: 0.8125rem;
            }
            main table th {
                font-size: 0.6875rem;
            }
            /* Guruh nomi (badge) shrifti 1440px da kichikroq */
            main table td span.rounded-full,
            main table td .rounded-full {
                font-size: 0.75rem !important;
                padding: 0.2rem 0.5rem !important;
            }
            main table td .text-xs.mt-1 {
                font-size: 0.6875rem !important;
            }
        }
        @media (max-width: 1200px) {
            main table th,
            main table td {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
            main table th {
                font-size: 0.625rem;
            }
        }
        @media (max-width: 992px) {
            main table th,
            main table td {
                padding: 0.35rem 0.5rem;
                font-size: 0.6875rem;
            }
            main table th {
                font-size: 0.625rem;
            }
            main table td .w-10.h-10 {
                width: 2rem;
                height: 2rem;
                font-size: 0.75rem;
            }
        }
        @media (max-width: 1440px) {
            main table td .w-10.h-10 {
                width: 2.25rem;
                height: 2.25rem;
                font-size: 0.8125rem;
            }
        }

        /* Laptop L — 1440px da sigʻishi uchun */
        @media (max-width: 1440px) {
            main {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            /* Import, Export, Qoʻshish tugmalari biroz kichikroq */
            main div.flex.gap-2.ml-auto a,
            main div.flex.gap-2.shrink-0 a,
            main div.flex.gap-3 button,
            main div.flex.gap-3 a {
                padding: 0.375rem 0.75rem !important;
                font-size: 0.8125rem !important;
                gap: 0.375rem !important;
            }
            main div.flex.gap-2.ml-auto a svg,
            main div.flex.gap-2.shrink-0 a svg,
            main div.flex.gap-3 button svg,
            main div.flex.gap-3 a svg {
                width: 1rem !important;
                height: 1rem !important;
            }
            /* Sarlavha qatoridagi bitta tugma (Yangi fakultet va sh.k.) */
            main div.flex.justify-between > a {
                padding: 0.375rem 0.75rem !important;
                font-size: 0.8125rem !important;
                gap: 0.375rem !important;
            }
            main div.flex.justify-between > a svg {
                width: 1rem !important;
                height: 1rem !important;
            }
            /* Qidirish, Tozalash va form tugmalari ham kichikroq */
            main form button[type="submit"],
            main form.flex a {
                padding: 0.375rem 0.75rem !important;
                font-size: 0.8125rem !important;
            }
            /* Fakultet kartochkalari 1440px da biroz kichikroq */
            main .faculties-cards { gap: 0.75rem !important; }
            main .faculties-cards > div .p-6 { padding: 1rem !important; }
            main .faculties-cards .w-14.h-14 {
                width: 2.5rem !important;
                height: 2.5rem !important;
                font-size: 0.875rem !important;
            }
            main .faculties-cards .w-14.h-14 span { font-size: 0.875rem !important; }
            main .faculties-cards h3.text-lg { font-size: 1rem !important; margin-bottom: 0.5rem !important; }
            main .faculties-cards .text-sm.mb-4 { margin-bottom: 0.75rem !important; font-size: 0.8125rem !important; }
            main .faculties-cards .mb-4.p-3 { padding: 0.5rem 0.75rem !important; margin-bottom: 0.75rem !important; }
            main .faculties-cards .grid.gap-3 .p-3 { padding: 0.5rem !important; }
            main .faculties-cards .grid.gap-3 { gap: 0.5rem !important; }
            main .faculties-cards .text-2xl { font-size: 1.25rem !important; }
            main .faculties-cards .p-2 svg { width: 1rem !important; height: 1rem !important; }
            /* Yoʻnalishlar — qabul yili va ichidagilar 1440px da kichikroq */
            main .directions-years { gap: 0.75rem !important; }
            main .directions-years .directions-year-btn {
                padding: 0.5rem 1rem !important;
                font-size: 0.875rem !important;
            }
            main .directions-years .directions-year-btn .text-xl { font-size: 1rem !important; }
            main .directions-years .directions-year-btn .w-6.h-6 { width: 1.25rem !important; height: 1.25rem !important; }
            main .directions-years .directions-year-btn .gap-4 { gap: 0.5rem !important; }
            main .directions-years .directions-year-btn .p-2 { padding: 0.375rem !important; }
            main .directions-years .border-t + div .p-4 { padding: 0.75rem !important; }
            main .directions-years .space-y-4 { gap: 0.75rem !important; }
            main .directions-years .rounded-xl .p-4 { padding: 0.75rem !important; }
            main .directions-years h3.text-lg { font-size: 0.9375rem !important; }
            main .directions-years .text-sm.mt-1 { font-size: 0.75rem !important; margin-top: 0.25rem !important; }
            main .directions-years a.text-sm.px-3.py-2 { padding: 0.375rem 0.75rem !important; font-size: 0.8125rem !important; }
            main .directions-years a.text-sm.px-3.py-2 svg { width: 1rem !important; height: 1rem !important; }
            main .directions-years .hidden.bg-white.p-6 { padding: 0.75rem 1rem !important; }
            main .directions-years .space-y-8 { gap: 1rem !important; }
            main .directions-years .px-4.py-3 { padding: 0.5rem 0.75rem !important; font-size: 0.8125rem !important; }
            main .directions-years .p-4 .mb-6 { margin-bottom: 0.75rem !important; }
            main .directions-years h4.text-sm { font-size: 0.6875rem !important; margin-bottom: 0.5rem !important; }
            main .directions-years .p-3.rounded-lg { padding: 0.5rem 0.75rem !important; }
            main .directions-years h5.text-base { font-size: 0.875rem !important; }
            main .directions-years .bg-gray-100.px-3.py-1 { padding: 0.25rem 0.5rem !important; font-size: 0.75rem !important; }
            /* Fanlar bazasi — curriculum-subjects (o'quv reja fanlari kartochkalari) 1440px da kichikroq */
            main .curriculum-subjects-page .curriculum-subjects-cards { gap: 0.5rem !important; }
            main .curriculum-subject-card .relative.p-5 { padding: 0.5rem 0.75rem !important; }
            main .curriculum-subject-card .absolute.top-4.right-4 { top: 0.375rem !important; right: 0.375rem !important; gap: 0.125rem !important; }
            main .curriculum-subject-card .absolute .px-3.py-1,
            main .curriculum-subject-card .absolute span { padding: 0.125rem 0.375rem !important; font-size: 0.5625rem !important; }
            main .curriculum-subject-card .pr-24 { padding-right: 4rem !important; }
            main .curriculum-subject-card h3,
            main .curriculum-subject-card h3.text-2xl { font-size: 0.9375rem !important; line-height: 1.2 !important; margin-bottom: 0.375rem !important; }
            main .curriculum-subject-card .relative.p-5 p,
            main .curriculum-subject-card .text-lg.font-medium { font-size: 0.75rem !important; margin-bottom: 0.375rem !important; line-height: 1.25 !important; }
            main .curriculum-subject-card .relative .flex.flex-wrap.gap-2 span,
            main .curriculum-subject-card .flex.flex-wrap.gap-2 .px-3.py-1.5 { padding: 0.125rem 0.375rem !important; font-size: 0.5625rem !important; }
            main .curriculum-subject-card .relative .flex.flex-wrap.gap-2 { gap: 0.25rem !important; margin-bottom: 0.25rem !important; }
            main .curriculum-subject-card > .p-5 { padding: 0.5rem 0.75rem !important; }
            main .curriculum-subject-card > .p-5 p,
            main .curriculum-subject-card > .p-5 .text-sm.mb-4 { margin-bottom: 0.375rem !important; font-size: 0.6875rem !important; line-height: 1.3 !important; }
            main .curriculum-subject-card > .p-5 .flex-wrap.gap-2,
            main .curriculum-subject-card > .p-5 .flex-wrap.gap-2 span { gap: 0.25rem !important; font-size: 0.5625rem !important; }
            /* Fanlar bazasi — jadval (fan qatori) 1440px da kichikroq */
            main .subjects-table-wrap .subjects-table th,
            main .subjects-table-wrap .subjects-table td {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.8125rem !important;
            }
            main .subjects-table-wrap .subjects-table .font-medium.text-base { font-size: 0.875rem !important; }
            main .subjects-table-wrap .subjects-table .text-sm { font-size: 0.8125rem !important; }
            main .subjects-table-wrap .subjects-table .text-xs { font-size: 0.6875rem !important; }
            main .subjects-table-wrap .subjects-table .p-2 { padding: 0.375rem !important; }
            main .subjects-table-wrap .subjects-table .p-2 svg { width: 1rem !important; height: 1rem !important; }
            /* Fakultet ichidagi yoʻnalish (faculty_detail) — 1440px da kichikroq */
            main .faculty-detail-years { gap: 0.75rem !important; }
            main .faculty-detail-years .faculty-year-btn {
                padding: 0.5rem 1rem !important;
                font-size: 0.875rem !important;
            }
            main .faculty-detail-years .faculty-year-btn .text-xl { font-size: 1rem !important; }
            main .faculty-detail-years .faculty-year-btn .w-6.h-6 { width: 1.25rem !important; height: 1.25rem !important; }
            main .faculty-detail-years .faculty-year-btn .gap-4 { gap: 0.5rem !important; }
            main .faculty-detail-years .faculty-year-btn .p-2 { padding: 0.375rem !important; }
            main .faculty-detail-years .bg-gray-50 .p-4 { padding: 0.75rem !important; }
            main .faculty-detail-years .space-y-4 { gap: 0.75rem !important; }
            main .faculty-detail-years .rounded-xl.overflow-hidden .p-4 { padding: 0.75rem !important; }
            main .faculty-detail-years h3.text-lg { font-size: 0.9375rem !important; }
            main .faculty-detail-years .text-sm.mt-1 { font-size: 0.75rem !important; margin-top: 0.25rem !important; }
            main .faculty-detail-years a.text-sm.px-3.py-2 { padding: 0.375rem 0.75rem !important; font-size: 0.8125rem !important; }
            main .faculty-detail-years a.text-sm.px-3.py-2 svg { width: 1rem !important; height: 1rem !important; }
            main .faculty-detail-years .hidden.bg-white.p-6 { padding: 0.75rem 1rem !important; }
            main .faculty-detail-years .space-y-8 { gap: 1rem !important; }
            main .faculty-detail-years .px-4.py-3 { padding: 0.5rem 0.75rem !important; font-size: 0.8125rem !important; }
            main .faculty-detail-years .p-4 .mb-6 { margin-bottom: 0.75rem !important; }
            main .faculty-detail-years h4.text-sm { font-size: 0.6875rem !important; margin-bottom: 0.5rem !important; }
            main .faculty-detail-years .p-3.rounded-lg { padding: 0.5rem 0.75rem !important; }
            main .faculty-detail-years h5.text-base { font-size: 0.875rem !important; }
            main .faculty-detail-years .bg-gray-100.px-3.py-1 { padding: 0.25rem 0.5rem !important; font-size: 0.75rem !important; }
            /* Dars jadvali — 1440px da to'g'rilash */
            main .schedule-page h1.text-2xl { font-size: 1.25rem !important; }
            main .schedule-page .flex.justify-between.items-center.mb-6 p { font-size: 0.8125rem !important; }
            main .schedule-page .flex.justify-between.items-center.mb-6 .flex.gap-2 a,
            main .schedule-page .flex.justify-between.items-center.mb-6 .flex.gap-2 button { padding: 0.375rem 0.625rem !important; font-size: 0.75rem !important; }
            main .schedule-page .flex.justify-between.items-center.mb-6 .flex.gap-2 a svg,
            main .schedule-page .flex.justify-between.items-center.mb-6 .flex.gap-2 button svg { width: 1rem !important; height: 1rem !important; }
            main .schedule-page .bg-white.rounded-2xl.shadow-sm.border.p-6.mb-6 { padding: 0.75rem 1rem !important; }
            main .schedule-page .bg-white.rounded-2xl.shadow-sm.border.p-6.mb-6 .grid.gap-4 { gap: 0.5rem !important; }
            main .schedule-page .bg-white.rounded-2xl.shadow-sm.border.p-6.mb-6 label { font-size: 0.6875rem !important; }
            main .schedule-page .bg-white.rounded-2xl.shadow-sm.border.p-6.mb-6 select,
            main .schedule-page .bg-white.rounded-2xl.shadow-sm.border.p-6.mb-6 input { padding: 0.375rem 0.5rem !important; font-size: 0.8125rem !important; }
            main .schedule-page .flex.items-end.gap-3.pt-6 button,
            main .schedule-page .flex.items-end.gap-3.pt-6 a { padding: 0.375rem 0.625rem !important; font-size: 0.8125rem !important; }
            main .schedule-page .px-4.py-4.border-b { padding: 0.5rem 0.75rem !important; }
            main .schedule-page .px-4.py-4 h2.text-xl { font-size: 0.9375rem !important; min-width: auto !important; }
            main .schedule-page .px-4.py-4 .w-9.h-9 { width: 1.75rem !important; height: 1.75rem !important; }
            main .schedule-page .px-4.py-4 .w-9.h-9 svg { width: 1rem !important; height: 1rem !important; }
            main .schedule-page .px-4.py-4 .flex.items-center.gap-2 select { padding: 0.25rem 0.5rem !important; font-size: 0.8125rem !important; }
            main .schedule-page .px-4.py-4 button[type="submit"] { padding: 0.375rem 0.625rem !important; font-size: 0.75rem !important; }
            /* Kun headeri (Dushanba, Seshanba...) — 1440px da ham ranglar bir hil */
            main .schedule-page .grid.grid-cols-7.text-center.text-xs { font-size: 0.6875rem !important; padding: 0.375rem 0 !important; color: #374151 !important; background-color: #e5e7eb !important; border-bottom-color: #e5e7eb !important; }
            main .schedule-page .grid.grid-cols-7.text-center.text-xs > div { color: #374151 !important; }
            main .schedule-page .grid.grid-cols-7.gap-3.bg-gray-200 { gap: 0.25rem !important; padding: 0.25rem !important; background-color: #e5e7eb !important; }
            main .schedule-page .min-h-\[160px\].p-4 { min-height: 7.5rem !important; padding: 0.375rem !important; gap: 0.25rem !important; }
            /* Bo'sh kun — faqat sana va "+" (1440px da ham yig'ilgan bo'lsin) */
            main .schedule-page .min-h-\[160px\].p-4.schedule-day-empty { min-height: auto !important; height: auto !important; padding: 0.375rem 0.5rem !important; gap: 0 !important; }
            /* O'tgan/keyingi oy kunlari ham dars bo'lmasa yig'ilgan */
            main .schedule-page .min-h-\[160px\].p-4.schedule-day-placeholder,
            main .schedule-page .min-h-\[160px\].p-4.schedule-day-other-month { min-height: auto !important; height: auto !important; padding: 0.375rem 0.5rem !important; gap: 0 !important; }
            main .schedule-page .min-h-\[160px\] .text-sm.font-bold { font-size: 0.75rem !important; }
            main .schedule-page .min-h-\[160px\] .w-7.h-7 { width: 1.5rem !important; height: 1.5rem !important; font-size: 0.75rem !important; }
            main .schedule-page .min-h-\[160px\] .w-6.h-6 { width: 1.25rem !important; height: 1.25rem !important; }
            main .schedule-page .min-h-\[160px\] .flex.flex-col.gap-2 { gap: 0.25rem !important; }
            main .schedule-page .min-h-\[160px\] .p-2.rounded-xl { padding: 0.375rem !important; }
            main .schedule-page .min-h-\[160px\] .text-\[10px\] { font-size: 0.5625rem !important; padding: 0.125rem 0.25rem !important; }
            main .schedule-page .min-h-\[160px\] .text-\[11px\].font-bold { font-size: 0.5625rem !important; line-height: 1.2 !important; margin-bottom: 0.125rem !important; }
            main .schedule-page .min-h-\[160px\] .text-\[9px\] { font-size: 0.5rem !important; }
            main .schedule-page .min-h-\[160px\] .flex.gap-1\.5 a,
            main .schedule-page .min-h-\[160px\] .flex.gap-1\.5 button { width: 1.25rem !important; height: 1.25rem !important; }
            main .schedule-page .min-h-\[160px\] .flex.gap-1\.5 svg { width: 0.75rem !important; height: 0.75rem !important; }
            main .schedule-page .min-h-\[160px\] a.bg-primary-600.text-white { padding: 0.125rem 0.25rem !important; font-size: 0.5rem !important; }
            main .schedule-page .min-h-\[160px\] a.bg-primary-600 svg { width: 0.625rem !important; height: 0.625rem !important; }
        }
        /* Dars kiritilmagan kun — faqat sana va "+" ko'rinadi (barcha ekranlar) */
        main .schedule-page .schedule-day-empty,
        main .schedule-page .min-h-\[160px\].schedule-day-empty {
            min-height: auto !important;
            height: auto !important;
            padding: 0.375rem 0.5rem !important;
            gap: 0 !important;
        }
        main .schedule-page .schedule-day-empty > .flex.flex-col.gap-2 {
            display: none !important;
        }
        /* Oy boshi va oxiridagi kataklar (o'tgan/keyingi oy kunlari) — yig'ilgan */
        main .schedule-page .schedule-day-placeholder {
            min-height: auto !important;
            height: auto !important;
            padding: 0.375rem 0.5rem !important;
        }
        @media (min-width: 1440px) {
            body .flex > div:last-of-type {
                max-width: calc(100vw - 16rem);
                min-width: 0;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    {% block extra_head %}{% endblock %}
</head>

<body class="bg-gradient-to-br from-slate-50 via-sky-50 to-slate-100 min-h-screen">
    {% if ticker_visible and request.endpoint not in ['auth.login', 'auth.forgot_password', 'auth.reset_password'] %}
    <div id="flash-ticker-global" class="fixed left-0 right-0 z-[25] h-8 bg-sky-800 border-b border-sky-700/50 flex items-center overflow-hidden {% if current_user.is_authenticated %}top-14 lg:top-16 lg:left-64{% else %}top-0{% endif %}" style="padding-inline: 1rem;">
        <div class="ticker-wrap flex-1 overflow-hidden min-w-0 relative">
            {% if ticker_items and ticker_items|length > 0 %}
            <div class="ticker-track flex items-center" style="width: max-content; min-width: 100%; --ticker-slot-min: 100%; backface-visibility: hidden;">
                <div class="ticker-gap flex-shrink-0 flex-none" style="width: var(--ticker-slot-min, 400px); min-width: var(--ticker-slot-min, 400px);"></div>
                {% for item in ticker_items %}
                <div class="ticker-slide flex-shrink-0 flex items-center whitespace-nowrap px-4 font-bold text-sm" style="min-width: var(--ticker-slot-min, 400px);">
                    {% if item.url %}<a href="{{ item.url }}" target="_blank" rel="noopener" class="no-underline {% if item.text_color == 'red' %}text-red-500{% else %}text-white{% endif %}">{{ item.text }}</a>{% else %}<span class="{% if item.text_color == 'red' %}text-red-500{% else %}text-white{% endif %}">{{ item.text }}</span>{% endif %}
                </div>
                <div class="ticker-gap ticker-gap-short flex-shrink-0 flex-none" style="width: calc(var(--ticker-slot-min, 400px) * 0.35); min-width: calc(var(--ticker-slot-min, 400px) * 0.35);"></div>
                {% endfor %}
                <div class="ticker-gap flex-shrink-0 flex-none" style="width: var(--ticker-slot-min, 400px); min-width: var(--ticker-slot-min, 400px);"></div>
            </div>
            {% elif ticker_text %}
            {% if ticker_url %}
            <a href="{{ ticker_url }}" target="_blank" rel="noopener"
                class="ticker-item inline-block font-bold text-sm no-underline whitespace-nowrap px-2 {% if ticker_text_color == 'red' %}text-red-500{% else %}text-white{% endif %}" style="padding-left: 100%;">
                {{ ticker_text }}
            </a>
            {% else %}
            <span class="ticker-item inline-block font-bold text-sm whitespace-nowrap px-2 {% if ticker_text_color == 'red' %}text-red-500{% else %}text-white{% endif %}" style="padding-left: 100%;">{{ ticker_text }}</span>
            {% endif %}
            {% endif %}
        </div>
    </div>
    <style>
        #flash-ticker-global .ticker-item { animation: ticker-scroll 60s linear infinite; }
        #flash-ticker-global .ticker-track { animation: ticker-slides var(--ticker-duration, 60s) linear infinite; }
        #flash-ticker-global:hover .ticker-item { animation-play-state: paused; }
        #flash-ticker-global:hover .ticker-track { animation-play-state: paused; }
        @keyframes ticker-scroll { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
        @keyframes ticker-slides { 0% { transform: translate(0, 0); } 100% { transform: translate(var(--ticker-scroll-end, -100%), 0); } }
    </style>
    <script>
        (function() {
            function updateTickerSpeed() {
                var tickerItem = document.querySelector('#flash-ticker-global .ticker-item');
                var tickerTrack = document.querySelector('#flash-ticker-global .ticker-track');
                var speedPerSlide = 20;
                if (tickerItem) {
                    var width = tickerItem.offsetWidth;
                    var duration = Math.max(5, width / 90);
                    tickerItem.style.animationDuration = duration + 's';
                }
                if (tickerTrack) {
                    var wrap = tickerTrack.closest('.ticker-wrap');
                    if (wrap) {
                        var wrapW = wrap.offsetWidth;
                        tickerTrack.style.setProperty('--ticker-slot-min', wrapW + 'px');
                    }
                    var slideCount = tickerTrack.querySelectorAll('.ticker-slide').length;
                    tickerTrack.style.setProperty('--ticker-duration', (slideCount * speedPerSlide) + 's');
                    var trackW = tickerTrack.offsetWidth;
                    if (wrap && trackW > wrap.offsetWidth) {
                        tickerTrack.style.setProperty('--ticker-scroll-end', '-' + (trackW - wrap.offsetWidth) + 'px');
                    } else {
                        tickerTrack.style.setProperty('--ticker-scroll-end', 'calc(-100% * (' + (tickerTrack.children.length - 1) + ') / ' + tickerTrack.children.length + ')');
                    }
                }
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updateTickerSpeed);
            } else {
                updateTickerSpeed();
            }
            window.addEventListener('resize', updateTickerSpeed);
        })();
    </script>
    {% endif %}

    {% if current_user.is_authenticated %}
    {% set current_role = session.get('current_role', current_user.role) %}
    {% if current_role not in current_user.get_roles() %}
    {% set current_role = current_user.role %}
    {% endif %}
    <div class="flex">
        <!-- Mobile menu overlay -->
        <div id="mobile-menu-overlay" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"
            onclick="toggleMobileMenu()"></div>

        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed left-0 top-0 h-screen w-64 bg-dark-900 text-white flex flex-col z-50 shadow-xl transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
            <!-- Logo -->
            <div class="p-4 lg:p-6 border-b border-dark-700 relative">
                <div class="flex items-center justify-center">
                    <div class="flex items-center gap-3">
                        {% if site_logo_filename %}
                        <img src="{{ url_for('admin.serve_site_upload', filename=site_logo_filename) }}"
                            alt="{{ site_name_short or site_institution_name or '' }}" class="h-20 w-auto object-contain">
                        {% endif %}
                        <div class="flex flex-col items-center text-center">
                            <span class="text-white font-bold text-lg">{{ site_institution_name or '' }}</span>
                            <span class="text-gray-300 text-xs">{{ site_tagline or '' }}</span>
                        </div>
                    </div>
                </div>
                <button onclick="toggleMobileMenu()"
                    class="lg:hidden absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-lg hover:bg-dark-800 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Navigation -->
            <nav id="sidebar-nav" class="flex-1 overflow-y-auto py-4 px-3">
                <div class="space-y-1">
                    <a href="{{ url_for('main.dashboard') }}"
                        class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'main.dashboard' %}active{% endif %}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                        <span class="text-sm font-medium">{{ t('dashboard') }}</span>
                    </a>

                    {% if current_role not in ['accounting', 'admin', 'dean', 'edu_dept', 'department_head'] %}
                    <a href="{{ url_for('courses.index') }}"
                        class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if 'courses' in request.endpoint and request.endpoint != 'courses.grades' %}active{% endif %}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        <span class="text-sm font-medium">{{ t('subjects') }}</span>
                    </a>
                    {% endif %}

                    {% if current_role in ['student'] %}
                    <a href="{{ url_for('courses.grades') }}"
                        class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'courses.grades' %}active{% endif %}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                        <span class="text-sm font-medium">{{ t('grades') }}</span>
                    </a>
                    {% endif %}

                    {% if current_role in ['student', 'teacher'] %}
                    <a href="{{ url_for('main.schedule') }}"
                        class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'main.schedule' %}active{% endif %}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span class="text-sm font-medium">{{ t('schedule') }}</span>
                    </a>
                    {% endif %}

                    {% if current_role == 'student' %}
                    <a href="{{ url_for('accounting.student_payments', student_id=current_user.id) }}"
                        class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if 'accounting' in request.endpoint %}active{% endif %}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="text-sm font-medium">{{ t('payment_info') }}</span>
                    </a>
                    {% endif %}

                    {% if current_user.is_superadmin or current_user.has_permission('view_accounting', current_role) or current_user.has_permission('view_contract_amounts', current_role) %}
                    <div class="pt-4 mt-4 border-t border-dark-700">
                        {% if current_role == 'accounting' %}
                        <p class="px-4 text-xs font-semibold text-purple-400 uppercase mb-2">{{ t('accounting') }}</p>
                        {% endif %}
                        {% if current_user.is_superadmin or current_user.has_permission('view_accounting', current_role) %}
                        <a href="{{ url_for('accounting.index') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'accounting.index' %}active{% endif %}">
                            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <rect x="2" y="5" width="20" height="14" rx="2" stroke-width="2"/>
                                <circle cx="7" cy="12" r="1.5"/>
                                <circle cx="17" cy="12" r="1.5"/>
                                <path stroke-linecap="round" stroke-width="2" d="M10 9h4M10 12h4M10 15h4"/>
                            </svg>
                            <span class="text-sm font-medium">{{ t('payment_info') }}</span>
                        </a>
                        {% endif %}
                        {% if current_user.is_superadmin or current_user.has_permission('view_contract_amounts', current_role) %}
                        <a href="{{ url_for('accounting.contract_amounts') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if 'contract_amount' in (request.endpoint or '') %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('contract_amounts_title') }}</span>
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}

                    <a href="{{ url_for('main.messages') }}"
                        class="sidebar-link flex items-center justify-between px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if 'messages' in request.endpoint or 'chat' in request.endpoint %}active{% endif %}">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('messages') }}</span>
                        </div>
                        {% if unread_msg_count > 0 %}
                        <span
                            class="flex items-center justify-center min-w-[20px] h-5 px-1.5 text-[10px] font-bold text-white bg-red-500 rounded-full animate-pulse">
                            {{ unread_msg_count }}
                        </span>
                        {% endif %}
                    </a>

                    <a href="{{ url_for('main.library') }}"
                        class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if 'library' in request.endpoint %}active{% endif %}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        <span class="text-sm font-medium">{{ t('electronic_library') }}</span>
                    </a>

                    <a href="{{ url_for('main.announcements') }}"
                        class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if 'announcement' in request.endpoint %}active{% endif %}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <span class="text-sm font-medium">{{ t('announcements') }}</span>
                    </a>

                    {% if current_user.is_superadmin %}
                    <a href="{{ url_for('admin.reklamalar') }}"
                        class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'admin.reklamalar' %}active{% endif %}">
                        <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <rect x="2" y="2" width="20" height="20" rx="2.5" stroke-width="2"/>
                            <circle cx="5.5" cy="5.5" r="1" fill="currentColor"/>
                            <circle cx="9.5" cy="5.5" r="1" fill="currentColor"/>
                            <circle cx="13.5" cy="5.5" r="1" fill="currentColor"/>
                            <text x="12" y="13.5" text-anchor="middle" font-size="3.5" font-weight="bold" fill="currentColor" font-family="system-ui, sans-serif">ADS</text>
                            <line x1="5" y1="17" x2="15" y2="17" stroke-width="1.5" stroke-linecap="round"/>
                            <line x1="5" y1="20" x2="10" y2="20" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span class="text-sm font-medium">{{ t('reklamalar') }}</span>
                    </a>
                    {% endif %}

                    <!-- ADMIN MENU (faqat tanlangan rol uchun tegishli bo'limlar) -->
                    {% if current_role in ['admin', 'edu_dept', 'department_head'] %}
                    <div class="pt-4 mt-4 border-t border-dark-700">
                        <p class="px-4 text-xs font-semibold text-primary-400 uppercase mb-2">{{ t('administrator') if current_role == 'admin' else (t('edu_dept') if current_role == 'edu_dept' else t('department_head')) }}</p>

                        {% if current_user.is_superadmin or current_user.has_permission('view_admin_panel', current_role) %}
                        <a href="{{ url_for('admin.index') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'admin.index' %}active{% endif %}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('admin_panel') }}</span>
                        </a>
                        {% endif %}

                        {% if current_user.is_superadmin or current_user.has_permission('view_staff', current_role) %}
                        <a href="{{ url_for('admin.staff') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'admin.staff' %}active{% endif %}">
                            <svg class="w-5 h-5 shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                                <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 16H5V8h14v11z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('staff_database') }}</span>
                        </a>
                        {% endif %}

                        {% if current_user.is_superadmin or current_user.has_permission('view_students', current_role) %}
                        <a href="{{ url_for('admin.students') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'admin.students' %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('students_database') }}</span>
                        </a>
                        {% endif %}

                        {% if current_user.is_superadmin or current_user.has_permission('view_faculties', current_role) %}
                        <a href="{{ url_for('admin.faculties') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if 'admin.facult' in request.endpoint %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('faculties') }}</span>
                        </a>
                        {% endif %}
                        {% if current_user.is_superadmin or current_user.has_permission('view_departments', current_role) %}
                        <a href="{{ url_for('admin.departments') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'admin.departments' or (request.endpoint and 'admin.department' in request.endpoint) %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('departments') }}</span>
                        </a>
                        {% endif %}
                        {% if current_user.is_superadmin or current_user.has_permission('view_directions', current_role) %}
                        <a href="{{ url_for('admin.directions') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'admin.directions' or (request.endpoint and 'admin.direction' in request.endpoint) %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('directions') }}</span>
                        </a>
                        {% endif %}
                        {% if current_user.is_superadmin or current_user.has_permission('manage_groups', current_role) %}
                        <a href="{{ url_for('admin.groups') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'admin.groups' or (request.endpoint and 'admin.group' in request.endpoint) %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('groups') }}</span>
                        </a>
                        {% endif %}
                        {% if current_user.is_superadmin or current_user.has_permission('view_curriculum', current_role) %}
                        <a href="{{ url_for('courses.index') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint and request.endpoint.startswith('courses.') %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('subjects_database') }}</span>
                        </a>
                        {% endif %}
                        {% if current_role in ('edu_dept', 'admin', 'dean') %}
                        <a href="{{ url_for('main.fan_resurslari') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'main.fan_resurslari' %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('subject_resources') }}</span>
                        </a>
                        {% endif %}

                        {% if current_user.is_superadmin or current_user.has_permission('view_schedule', current_role) %}
                        <a href="{{ url_for('admin.schedule') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if 'admin.schedule' in request.endpoint %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('schedule') }}</span>
                        </a>
                        {% endif %}

                        {% if current_user.is_superadmin or current_user.has_permission('view_subjects', current_role) %}
                        <a href="{{ url_for('admin.subjects') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'admin.subjects' or (request.endpoint and 'subject' in request.endpoint and 'direction' not in request.endpoint and 'curriculum' not in request.endpoint) %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('subjects') }}</span>
                        </a>
                        {% endif %}

                        {% if current_user.is_superadmin or current_user.has_permission('view_accounting', current_role) %}
                        <a href="{{ url_for('accounting.index') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'accounting.index' %}active{% endif %}">
                            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <rect x="2" y="5" width="20" height="14" rx="2" stroke-width="2"/>
                                <circle cx="7" cy="12" r="1.5"/>
                                <circle cx="17" cy="12" r="1.5"/>
                                <path stroke-linecap="round" stroke-width="2" d="M10 9h4M10 12h4M10 15h4"/>
                            </svg>
                            <span class="text-sm font-medium">{{ t('payment_info') }}</span>
                        </a>
                        {% endif %}
                        {% if current_user.is_superadmin or current_user.has_permission('view_contract_amounts', current_role) %}
                        <a href="{{ url_for('accounting.contract_amounts') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if 'contract_amount' in (request.endpoint or '') %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('contract_amounts_title') }}</span>
                        </a>
                        {% endif %}

                        {% if current_user.is_superadmin or current_user.has_permission('view_reports', current_role) %}
                        <a href="{{ url_for('admin.reports') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'admin.reports' %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('reports') }}</span>
                        </a>
                        {% endif %}

                        {% if current_user.is_superadmin or current_user.has_permission('view_grade_scale', current_role) %}
                        <a href="{{ url_for('admin.grade_scale') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if 'grade' in request.endpoint %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('grading_system') }}</span>
                        </a>
                        {% endif %}
                        {% if current_user.is_superadmin %}
                        <a href="{{ url_for('admin.superadmins') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'admin.superadmins' or (request.endpoint and 'admin.superadmin' in request.endpoint) %}active{% endif %}">
                            <svg class="w-5 h-5 shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                            </svg>
                            <span class="text-sm font-medium">{{ t('superadmins_section') }}</span>
                        </a>
                        <a href="{{ url_for('admin.role_settings') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'admin.role_settings' %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a2 2 0 00-2-2h-2a2 2 0 00-2 2v2h2z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('role_settings') }}</span>
                        </a>
                        <a href="{{ url_for('admin.site_settings') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'admin.site_settings' %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span class="text-sm font-medium">{{ t('site_settings') }}</span>
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- DEAN MENU -->
                    {% if current_role == 'dean' %}
                    <div class="pt-4 mt-4 border-t border-dark-700">
                        <p class="px-4 text-xs font-semibold text-emerald-400 uppercase mb-2">{{ t('dean_office') }}</p>

                        <a href="{{ url_for('dean.index') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'dean.index' %}active{% endif %}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('dean_panel') }}</span>
                        </a>

                        <a href="{{ url_for('dean.students') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'dean.students' %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('students_database') }}</span>
                        </a>

                        <a href="{{ url_for('dean.directions') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'dean.directions' or (request.endpoint and 'dean.direction' in request.endpoint) %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('directions') }}</span>
                        </a>
                        <a href="{{ url_for('dean.groups') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'dean.groups' or (request.endpoint and 'dean.group' in request.endpoint) %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('groups') }}</span>
                        </a>
                        <a href="{{ url_for('courses.index') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint and request.endpoint.startswith('courses.') %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('subjects_database') }}</span>
                        </a>

                        <a href="{{ url_for('dean.schedule') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if 'dean.schedule' in request.endpoint %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('schedule') }}</span>
                        </a>

                        <a href="{{ url_for('dean.reports') }}"
                            class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-dark-300 hover:bg-dark-800 hover:text-white transition-all {% if request.endpoint == 'dean.reports' %}active{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            <span class="text-sm font-medium">{{ t('reports') }}</span>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </nav>

            <!-- User info -->
            <div class="p-4 border-t border-dark-700">
                <a href="{{ url_for('main.settings') }}"
                    class="block bg-gradient-to-r from-dark-800 to-dark-700 rounded-xl p-3 hover:from-dark-700 hover:to-dark-600 transition-colors cursor-pointer">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white font-bold">
                            {% if current_user.role != 'student' %}
                            {{ (current_user.login or current_user.full_name or 'U')[0].upper() }}
                            {% else %}
                            {{ (current_user.full_name or 'U')[0].upper() }}
                            {% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-white truncate">{{ current_user.full_name.upper() if
                                current_user.full_name else '-' }}</p>
                            <p class="text-xs text-primary-400">
                                {% if current_user.is_superadmin %}{{ t('superadmin') }}{% else %}{% set current_role = session.get('current_role', current_user.role) %}{% if current_role == 'admin' %}{{ t('administrator') }}{% elif current_role == 'dean' %}{{ t('dean') }}{% elif current_role == 'edu_dept' %}{{ t('edu_dept') }}{% elif current_role == 'department_head' %}{{ t('department_head') }}{% elif current_role == 'teacher' %}{{ t('teacher') }}{% elif current_role == 'student' %}{{ t('student') }}{% elif current_role == 'accounting' %}{{ t('accounting') }}{% else %}{{ current_role }}{% endif %}{% endif %}
                            </p>
                        </div>
                    </div>
                </a>
            </div>
        </aside>

        <!-- Main content — min-w-0: 1440px da overflow boʻlmasin -->
        <div class="lg:ml-64 flex-1 min-h-screen w-full min-w-0 max-w-full overflow-x-hidden">
            <!-- Header — barcha sahiflarda yuqorida mahkam (fixed) -->
            <header class="fixed top-0 left-0 right-0 lg:left-64 z-30 glass border-b border-gray-200/50">
                <div class="flex items-center justify-between h-14 lg:h-16 px-4 lg:px-6">
                    <!-- Mobile menu button -->
                    <button onclick="toggleMobileMenu()"
                        class="lg:hidden p-2 rounded-lg hover:bg-white/60 transition-colors text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <div class="flex-1 max-w-xl ml-2 lg:ml-0">
                        <div class="relative">
                            <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 lg:w-5 lg:h-5 text-gray-400"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <input type="text" placeholder="{{ t('search') }}..."
                                class="w-full pl-9 lg:pl-10 pr-3 lg:pr-4 py-2 lg:py-2.5 text-sm lg:text-base bg-white/60 border border-gray-200 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <!-- Language selector -->
                        <div class="relative group">
                            <button
                                class="flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-white/60 transition-colors text-gray-700">
                                <span class="text-lg">{{ languages[current_lang].flag }}</span>
                                <span class="text-sm font-medium hidden sm:inline">{{ languages[current_lang].name
                                    }}</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div
                                class="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-lg border border-gray-200 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                                {% for lang_code, lang_info in languages.items() %}
                                <a href="{{ url_for('main.set_language', lang=lang_code) }}"
                                    class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 transition-colors {% if current_lang == lang_code %}bg-primary-50{% endif %}">
                                    <span class="text-xl">{{ lang_info.flag }}</span>
                                    <span class="text-sm font-medium text-gray-900">{{ lang_info.name }}</span>
                                    {% if current_lang == lang_code %}
                                    <svg class="w-4 h-4 text-primary-600 ml-auto" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7" />
                                    </svg>
                                    {% endif %}
                                </a>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Profil dropdown -->
                        <div class="relative group">
                            <button onclick="toggleProfileMenu()"
                                class="flex items-center gap-3 p-2 rounded-xl hover:bg-white/60 transition-colors">
                                <div
                                    class="w-9 h-9 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white font-semibold text-sm shadow-md">
                                    {% if current_user.role != 'student' %}
                                    {{ (current_user.login or current_user.full_name or 'U')[0].upper() }}
                                    {% else %}
                                    {{ (current_user.full_name or 'U')[0].upper() }}
                                    {% endif %}
                                </div>
                                <div class="text-left hidden sm:block">
                                    {% if current_user.role != 'student' %}
                                    <p class="text-sm font-medium text-gray-900">{{ current_user.full_name.upper() if
                                        current_user.full_name else '-' }}</p>
                                    <p class="text-xs text-gray-500">{{ current_user.login or '-' }}</p>
                                    {% else %}
                                    <p class="text-sm font-medium text-gray-900">{{ current_user.full_name.upper() if
                                        current_user.full_name else '-' }}</p>
                                    <p class="text-xs text-gray-500">
                                        {% if current_user.group %}
                                        {{ current_user.group.name }}
                                        {% else %}
                                        {{ t('group_not_assigned') }}
                                        {% endif %}
                                    </p>
                                    {% endif %}
                                </div>
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>

                            <!-- Dropdown menu -->
                            <div id="profile-menu"
                                class="absolute right-0 top-full mt-2 w-64 bg-white rounded-xl shadow-lg border border-gray-200 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50"
                                style="display: none;">
                                {% set user_roles_raw = current_user.get_roles() %}
                                {% set current_role = session.get('current_role', current_user.role) %}
                                {% set role_order = ['admin', 'dean', 'edu_dept', 'department_head', 'teacher', 'accounting', 'student'] %}

                                {% if current_user.is_superadmin %}
                                <div class="p-2 border-b border-gray-100">
                                    <p class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase">{{ t('roles') }}</p>
                                    <p class="px-3 py-2 text-sm text-gray-700">{{ t('superadmin') }}</p>
                                </div>
                                {% elif user_roles_raw|length > 1 %}
                                <div class="p-2 border-b border-gray-100">
                                    <p class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase">{{ t('roles') }}</p>
                                    {# Rollarni belgilangan tartibda ko'rsatish: admin, dean, teacher, accounting,
                                    student #}
                                    {% for ordered_role in role_order %}
                                    {% if ordered_role in user_roles_raw %}
                                    <a href="{{ url_for('main.switch_role', role=ordered_role) }}"
                                        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors {% if ordered_role == current_role %}bg-primary-50{% endif %}">
                                        <div
                                            class="w-2 h-2 rounded-full {% if ordered_role == current_role %}bg-primary-600{% else %}bg-gray-300{% endif %}">
                                        </div>
                                        <span class="text-sm font-medium text-gray-900">{% if ordered_role == 'admin' %}{{ t('administrator') }}{% elif ordered_role == 'dean' %}{{ t('dean') }}{% elif ordered_role == 'edu_dept' %}{{ t('edu_dept') }}{% elif ordered_role == 'department_head' %}{{ t('department_head') }}{% elif ordered_role == 'teacher' %}{{ t('teacher') }}{% elif ordered_role == 'student' %}{{ t('student') }}{% elif ordered_role == 'accounting' %}{{ t('accounting') }}{% else %}{{ ordered_role }}{% endif %}</span>
                                        {% if ordered_role == current_role %}
                                        <svg class="w-4 h-4 text-primary-600 ml-auto" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 13l4 4L19 7" />
                                        </svg>
                                        {% endif %}
                                    </a>
                                    {% endif %}
                                    {% endfor %}
                                    {# Agar tartibda bo'lmagan rollar bo'lsa, ularni oxiriga qo'shish #}
                                    {% for role in user_roles_raw %}
                                    {% if role not in role_order %}
                                    <a href="{{ url_for('main.switch_role', role=role) }}"
                                        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors {% if role == current_role %}bg-primary-50{% endif %}">
                                        <div
                                            class="w-2 h-2 rounded-full {% if role == current_role %}bg-primary-600{% else %}bg-gray-300{% endif %}">
                                        </div>
                                        <span class="text-sm font-medium text-gray-900">{% if role == 'admin' %}{{ t('administrator') }}{% elif role == 'dean' %}{{ t('dean') }}{% elif role == 'edu_dept' %}{{ t('edu_dept') }}{% elif role == 'department_head' %}{{ t('department_head') }}{% elif role == 'teacher' %}{{ t('teacher') }}{% elif role == 'student' %}{{ t('student') }}{% elif role == 'accounting' %}{{ t('accounting') }}{% else %}{{ role }}{% endif %}</span>
                                        {% if role == current_role %}
                                        <svg class="w-4 h-4 text-primary-600 ml-auto" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 13l4 4L19 7" />
                                        </svg>
                                        {% endif %}
                                    </a>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <div class="p-2">
                                    <a href="{{ url_for('main.settings') }}"
                                        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <span class="text-sm font-medium">{{ t('profile_settings') }}</span>
                                    </a>
                                    <a href="{{ url_for('auth.logout') }}"
                                        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-red-50 transition-colors text-red-600">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                        </svg>
                                        <span class="text-sm font-medium">{{ t('logout') }}</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Header balandligi uchun bo'sh joy (fixed header ostida kontent chiqmasin) -->
            <div class="h-14 lg:h-16" aria-hidden="true"></div>

            <!-- Ticker uchun joy (fixed ticker ostida kontent chiqmasin) -->
            {% if ticker_visible %}
            <div class="h-8" aria-hidden="true"></div>
            {% endif %}

            <!-- Flash messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="fixed bottom-4 right-4 z-50 max-w-md w-full lg:max-w-lg space-y-2"
                id="flash-messages-container">
                {% for category, message in messages %}
                <div
                    class="p-4 rounded-xl flex items-center gap-3 shadow-lg {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200{% elif category == 'success' %}bg-emerald-50 text-emerald-700 border border-emerald-200{% else %}bg-sky-50 text-sky-700 border border-sky-200{% endif %} animate-slide-in">
                    {% if category == 'error' %}
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    {% elif category == 'success' %}
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    {% else %}
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    {% endif %}
                    <span class="flex-1">{{ message }}</span>
                    <button onclick="this.parentElement.parentElement.remove()"
                        class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                {% endfor %}
            </div>
            <script>
                // Flash message'larni avtomatik yopish
                setTimeout(function () {
                    const container = document.getElementById('flash-messages-container');
                    if (container) {
                        container.style.opacity = '0';
                        container.style.transition = 'opacity 0.5s';
                        setTimeout(function () {
                            container.remove();
                        }, 500);
                    }
                }, 5000);
            </script>
            {% endif %}
            {% endwith %}

            <!-- Page content -->
            <main class="p-3 lg:p-6">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    {% else %}
    <div class="{% if ticker_visible and request.endpoint not in ['auth.login', 'auth.forgot_password', 'auth.reset_password'] %}pt-8{% endif %} min-h-screen w-full overflow-x-hidden">
        {% block full_content %}{% endblock %}
    </div>
    {% endif %}

    {% block modals %}{% endblock %}

    {% block scripts %}{% endblock %}
    <script>
        // Session timeout - 30 daqiqada hech qanday amal bo'lmasa logout (video/audio ijro etayotganda hisobga olinadi)
        {% if current_user.is_authenticated %}
        (function() {
            let inactivityTimer;
            const TIMEOUT_DURATION = 30 * 60 * 1000; // 30 daqiqa (millisekundlarda)
            
            function resetTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(function() {
                    alert('{{ t("session_timeout_message") }}');
                    window.location.href = '{{ url_for("auth.logout") }}';
                }, TIMEOUT_DURATION);
            }
            
            // Odatiy faollik: sichqoncha, klaviatura, scroll
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click', 'keydown'].forEach(function(event) {
                document.addEventListener(event, resetTimer, true);
            });
            
            // Video/audio ijro etayotganda ham faollik hisoblanadi (uzoq video ko'rilganda logout bo'lmasin)
            setInterval(function() {
                var v = document.querySelectorAll('video');
                var a = document.querySelectorAll('audio');
                for (var i = 0; i < v.length; i++) { if (!v[i].paused) { resetTimer(); return; } }
                for (var i = 0; i < a.length; i++) { if (!a[i].paused) { resetTimer(); return; } }
            }, 60000); // har 1 daqiqada tekshirish
            
            resetTimer();
        })();
        {% endif %}
        
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-menu-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function toggleProfileMenu() {
            const menu = document.getElementById('profile-menu');
            if (menu.style.display === 'none' || menu.style.display === '') {
                menu.style.display = 'block';
                menu.classList.remove('opacity-0', 'invisible');
                menu.classList.add('opacity-100', 'visible');
            } else {
                menu.style.display = 'none';
                menu.classList.remove('opacity-100', 'visible');
                menu.classList.add('opacity-0', 'invisible');
            }
        }

        // Close profile menu when clicking outside
        document.addEventListener('click', function (event) {
            const profileMenu = document.getElementById('profile-menu');
            const profileButton = event.target.closest('[onclick="toggleProfileMenu()"]');
            if (profileMenu && !profileMenu.contains(event.target) && !profileButton) {
                profileMenu.style.display = 'none';
                profileMenu.classList.remove('opacity-100', 'visible');
                profileMenu.classList.add('opacity-0', 'invisible');
            }
        });

        // Close menu when clicking on a link (mobile)
        document.querySelectorAll('#sidebar a').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 1024) {
                    toggleMobileMenu();
                }
                // Sidebar scroll pozitsiyasini saqlab qolish (sahifa yangilanganda o'ynamasligi uchun)
                const sidebarNav = document.getElementById('sidebar-nav');
                if (sidebarNav && link.getAttribute('href') && !link.getAttribute('href').startsWith('#') && !link.target) {
                    try {
                        sessionStorage.setItem('sidebarScrollPosition', String(sidebarNav.scrollTop));
                    } catch (e) {}
                }
            });
        });
        // Sahifa yuklanganda sidebar scrollni tiklash (layout tayyor bo'lgach)
        document.addEventListener('DOMContentLoaded', function () {
            const sidebarNav = document.getElementById('sidebar-nav');
            if (sidebarNav) {
                try {
                    const saved = sessionStorage.getItem('sidebarScrollPosition');
                    if (saved !== null) {
                        const pos = parseInt(saved, 10);
                        if (!isNaN(pos)) {
                            requestAnimationFrame(function () { sidebarNav.scrollTop = pos; });
                        }
                        sessionStorage.removeItem('sidebarScrollPosition');
                    }
                } catch (e) {}
            }
        });
        // Global Flatpickr Initialization
        document.addEventListener('DOMContentLoaded', function () {
            var flatpickrLocales = {
                'uz': {
                    firstDayOfWeek: 1,
                    weekdays: {
                        shorthand: ["Ya", "Du", "Se", "Ch", "Pa", "Ju", "Sh"],
                        longhand: ["Yakshanba", "Dushanba", "Seshanba", "Chorshanba", "Payshanba", "Juma", "Shanba"]
                    },
                    months: {
                        shorthand: ["Yan", "Fev", "Mar", "Apr", "May", "Iyun", "Iyul", "Avg", "Sen", "Okt", "Noy", "Dek"],
                        longhand: ["Yanvar", "Fevral", "Mart", "Aprel", "May", "Iyun", "Iyul", "Avgust", "Sentyabr", "Oktyabr", "Noyabr", "Dekabr"]
                    }
                },
                'ru': {
                    firstDayOfWeek: 1,
                    weekdays: {
                        shorthand: ["Вс", "Пн", "Вт", "Ср", "Чт", "Пт", "Сб"],
                        longhand: ["Воскресенье", "Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота"]
                    },
                    months: {
                        shorthand: ["Янв", "Фев", "Мар", "Апр", "Май", "Июн", "Июл", "Авг", "Сен", "Окт", "Ноя", "Дек"],
                        longhand: ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"]
                    }
                },
                'en': {
                    firstDayOfWeek: 1,
                    weekdays: {
                        shorthand: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
                        longhand: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
                    },
                    months: {
                        shorthand: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                        longhand: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
                    }
                }
            };
            var currentLang = "{{ current_lang }}";
            var fpLocale = flatpickrLocales[currentLang] || flatpickrLocales['uz'];
            
            flatpickr(".flatpickr-date", {
                dateFormat: "Y-m-d", // Value sent to server
                altInput: true,
                altFormat: "d.m.Y", // Display format
                allowInput: true,
                locale: fpLocale,
                onReady: function (selectedDates, dateStr, instance) {
                    if (instance.altInput) {
                        const input = instance.altInput;
                        input.setAttribute('maxlength', 10);

                        input.addEventListener('input', function (e) {
                            // If user is deleting, don't force format to allow correction
                            if (e.inputType === 'deleteContentBackward') return;

                            let val = input.value.replace(/\D/g, '').substring(0, 8); // Max 8 digits
                            let newVal = '';

                            if (val.length > 4) {
                                newVal = val.substring(0, 2) + '.' + val.substring(2, 4) + '.' + val.substring(4, 8);
                            } else if (val.length > 2) {
                                newVal = val.substring(0, 2) + '.' + val.substring(2, 4);
                            } else {
                                newVal = val;
                            }

                            if (input.value !== newVal) {
                                input.value = newVal;
                            }
                        });
                    }
                }
            });
            // ISO Date Picker (YYYY-MM-DD) — har bir input uchun defaultDate bilan (tahrirlashda qiymat to‘ldirilsin)
            var isoDateOpts = {
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "Y-m-d",
                allowInput: true,
                locale: fpLocale,
                onReady: function (selectedDates, dateStr, instance) {
                    if (instance.altInput) {
                        var input = instance.altInput;
                        input.setAttribute('maxlength', 10);

                        input.addEventListener('input', function (e) {
                            if (e.inputType === 'deleteContentBackward') return;

                            var val = input.value.replace(/\D/g, '').substring(0, 8);
                            var newVal = '';

                            if (val.length > 6) {
                                newVal = val.substring(0, 4) + '-' + val.substring(4, 6) + '-' + val.substring(6, 8);
                            } else if (val.length > 4) {
                                newVal = val.substring(0, 4) + '-' + val.substring(4, 6);
                            } else {
                                newVal = val;
                            }

                            if (input.value !== newVal) {
                                input.value = newVal;
                            }
                        });
                    }
                }
            };
            document.querySelectorAll(".flatpickr-date-iso").forEach(function (el) {
                var opts = Object.assign({}, isoDateOpts);
                if (el.value && el.value.trim()) {
                    opts.defaultDate = el.value.trim();
                }
                flatpickr(el, opts);
            });
        });

        // Qidiruv/filtr input ichidagi "x" tugmasi: tozalash, blur (roʻyxat yopilsin), form yuborish
        (function() {
            function toggleClearBtn(btn, input) {
                if (!btn || !input) return;
                btn.classList.toggle('hidden', !input.value.trim());
            }
            function submitForm(form) {
                if (!form) return;
                var ev = new Event('submit', { cancelable: true, bubbles: true });
                form.dispatchEvent(ev);
                if (!ev.defaultPrevented) form.submit();
            }
            document.addEventListener('DOMContentLoaded', function() {
                try {
                    document.querySelectorAll('.search-input-wrap').forEach(function(wrap) {
                        var input = wrap.querySelector('input[name="search"]');
                        var btn = wrap.querySelector('.search-clear-btn');
                        if (!input || !btn) return;
                        toggleClearBtn(btn, input);
                        input.addEventListener('input', function() { toggleClearBtn(btn, input); });
                        input.addEventListener('change', function() { toggleClearBtn(btn, input); });
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            input.value = '';
                            input.blur();
                            toggleClearBtn(btn, input);
                            submitForm(wrap.closest('form'));
                        });
                    });
                } catch (err) { console.warn('Search clear init:', err); }
            });

            // Filtr select ichidagi "x" tugmasi: tozalash va form yuborish
            setTimeout(function() {
                try {
                    document.querySelectorAll('.filter-select-wrap').forEach(function(wrap) {
                        var select = wrap.querySelector('select');
                        var btn = wrap.querySelector('.filter-clear-btn');
                        if (!select || !btn) return;
                        var id = select.id || select.name;
                        function hasValue() {
                            if (window.tomSelectInstances && id && window.tomSelectInstances[id]) {
                                var v = window.tomSelectInstances[id].getValue();
                                return (typeof v === 'string' ? v : (Array.isArray(v) ? v[0] : v)) ? true : false;
                            }
                            return !!select.value;
                        }
                        function toggleBtn() { btn.classList.toggle('hidden', !hasValue()); }
                        toggleBtn();
                        if (window.tomSelectInstances && id && window.tomSelectInstances[id]) {
                            window.tomSelectInstances[id].on('change', toggleBtn);
                        } else {
                            select.addEventListener('change', toggleBtn);
                        }
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            if (window.tomSelectInstances && id && window.tomSelectInstances[id]) {
                                window.tomSelectInstances[id].clear();
                            } else {
                                select.value = '';
                            }
                            toggleBtn();
                            var form = wrap.closest('form');
                            if (form) {
                                var ev = new Event('submit', { cancelable: true, bubbles: true });
                                form.dispatchEvent(ev);
                                if (!ev.defaultPrevented) form.submit();
                            }
                        });
                    });
                } catch (err) { console.warn('Filter clear init:', err); }
            }, 0);
        })();
    </script>
</body>

</html>